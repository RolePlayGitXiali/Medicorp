<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fiche Mat√©riaux - M√©dicorp</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      .materials-page {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
      }

      .page-title {
        text-align: center;
        color: var(--primary);
        margin-bottom: 30px;
      }

      .materials-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      .material-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .section-title {
        background: var(--secondary);
        color: white;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 20px;
        font-weight: 600;
      }

      .material-card {
        border: 1px solid var(--border);
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 6px;
        transition: all 0.3s ease;
      }

      .material-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }

      .material-name {
        font-weight: 700;
        color: var(--primary);
        font-size: 1.1em;
        margin-bottom: 8px;
      }

      .material-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        font-size: 0.95em;
        margin-bottom: 10px;
      }

      .info-item {
        display: flex;
        justify-content: space-between;
      }

      .info-label {
        color: #666;
        font-weight: 500;
      }

      .info-value {
        font-weight: 600;
        color: var(--primary);
      }

      .price-highlight {
        background: var(--light);
        padding: 12px;
        border-radius: 4px;
        border-left: 4px solid var(--secondary);
        margin-top: 10px;
      }

      .total-price {
        font-size: 1.3em;
        font-weight: 700;
        color: var(--danger);
      }

      .composition {
        background: #f9f9f9;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 0.9em;
        border-left: 3px solid var(--warning);
      }

      .composition-title {
        font-weight: 600;
        color: var(--warning);
        margin-bottom: 8px;
      }

      .composition-item {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        color: #555;
      }

      .cost-breakdown {
        background: white;
        border: 1px solid var(--light);
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 0.85em;
      }

      .breakdown-item {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
      }

      .breakdown-label {
        color: #666;
      }

      .breakdown-value {
        font-weight: 600;
        color: var(--primary);
      }

      .category-badge {
        display: inline-block;
        background: var(--secondary);
        color: white;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 0.8em;
        margin-top: 8px;
      }

      .search-bar {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
      }

      .search-bar input {
        flex: 1;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 1em;
      }

      .filter-btn {
        padding: 10px 15px;
        background: var(--secondary);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
      }

      .filter-btn:hover {
        background: #2980b9;
      }

      .stats-panel {
        background: var(--light);
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        text-align: center;
      }

      .stat {
        padding: 10px;
        background: white;
        border-radius: 4px;
      }

      .stat-value {
        font-size: 1.5em;
        font-weight: 700;
        color: var(--secondary);
      }

      .stat-label {
        font-size: 0.85em;
        color: #666;
        margin-top: 5px;
      }

      @media print {
        body {
          background: white;
        }
        .materials-page {
          padding: 0;
        }
        .material-card {
          page-break-inside: avoid;
        }
      }
    </style>
  </head>
  <body>
    <div class="materials-page">
      <div class="page-title">
        <h1>üìã Fiche des Mat√©riaux - M√©dicorp</h1>
        <p>
          Tarification et composition des mat√©riaux pour
          achat/r√©approvisionement
        </p>
      </div>

      <div class="search-bar">
        <input
          type="text"
          id="searchInput"
          placeholder="Chercher un mat√©riau..."
        />
        <button class="filter-btn" onclick="filterMaterials('simple')">
          Simples
        </button>
        <button class="filter-btn" onclick="filterMaterials('composite')">
          Composites
        </button>
        <button class="filter-btn" onclick="filterMaterials('all')">
          Tous
        </button>
      </div>

      <div class="stats-panel">
        <div class="stat">
          <div class="stat-value" id="stat-simple">12</div>
          <div class="stat-label">Mat√©riaux simples</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="stat-composite">4</div>
          <div class="stat-label">Mat√©riaux composites</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="stat-min">0‚Ç¨</div>
          <div class="stat-label">Prix min</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="stat-max">0‚Ç¨</div>
          <div class="stat-label">Prix max</div>
        </div>
      </div>

      <div class="materials-container">
        <div class="material-section">
          <div class="section-title">üî∑ Mat√©riaux Simples</div>
          <div id="simple-materials"></div>
        </div>

        <div class="material-section">
          <div class="section-title">üîß Mat√©riaux Composites</div>
          <div id="composite-materials"></div>
        </div>
      </div>
    </div>

    <script>
      let allMaterials = { simple: [], composite: [] };
      let currentFilter = "all";

      document.addEventListener("DOMContentLoaded", () => {
        loadMaterials();
        setupSearch();
      });

      async function loadMaterials() {
        try {
          const response = await fetch("/api/materials");
          allMaterials = await response.json();
          renderMaterials();
          updateStats();
        } catch (error) {
          console.error("Erreur:", error);
        }
      }

      function renderMaterials() {
        renderSimpleMaterials();
        renderCompositeMaterials();
      }

      function renderSimpleMaterials() {
        const container = document.getElementById("simple-materials");
        const materials = filterBySearch(allMaterials.simple, "simple");

        container.innerHTML = materials
          .map(
            (mat) => `
                <div class="material-card">
                    <div class="material-name">${mat.name}</div>
                    <div class="material-info">
                        <div class="info-item">
                            <span class="info-label">Cat√©gorie:</span>
                            <span class="info-value">${mat.category}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Co√ªt/Unit√©:</span>
                            <span class="info-value">${mat.pricePerUnit.toFixed(2)}‚Ç¨</span>
                        </div>
                    </div>
                    <div class="price-highlight">
                        <strong>Prix unitaire: </strong>
                        <span class="total-price">${mat.totalCost.toFixed(2)}‚Ç¨</span>
                    </div>
                    <span class="category-badge">${mat.category}</span>
                </div>
            `,
          )
          .join("");
      }

      function renderCompositeMaterials() {
        const container = document.getElementById("composite-materials");
        const materials = filterBySearch(allMaterials.composite, "composite");

        container.innerHTML = materials
          .map(
            (mat) => `
                <div class="material-card">
                    <div class="material-name">${mat.name}</div>
                    <div class="material-info">
                        <div class="info-item">
                            <span class="info-label">Cat√©gorie:</span>
                            <span class="info-value">${mat.category}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Rendement:</span>
                            <span class="info-value">${mat.yield} unit√©(s)</span>
                        </div>
                    </div>
                    
                    ${
                      Object.keys(mat.composition).length > 0
                        ? `
                        <div class="composition">
                            <div class="composition-title">üì¶ Composition requise:</div>
                            ${Object.entries(mat.composition)
                              .map(([matId, qty]) => {
                                const compMat =
                                  allMaterials.simple.find(
                                    (m) => m.id === matId,
                                  ) ||
                                  allMaterials.composite.find(
                                    (m) => m.id === matId,
                                  );
                                return `
                                    <div class="composition-item">
                                        <span>${compMat?.name || matId} :</span>
                                        <strong>${qty} unit√©(s)</strong>
                                    </div>
                                `;
                              })
                              .join("")}
                        </div>
                    `
                        : ""
                    }
                    
                    <div class="cost-breakdown">
                        <div class="breakdown-item">
                            <span class="breakdown-label">Prix mat√©riau:</span>
                            <span class="breakdown-value">${mat.breakdownCost.materialCost.toFixed(2)}‚Ç¨</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-label">Co√ªt fabrication:</span>
                            <span class="breakdown-value">${mat.breakdownCost.fabricationCost.toFixed(2)}‚Ç¨</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-label">Co√ªt composition:</span>
                            <span class="breakdown-value">${mat.breakdownCost.compositionCost.toFixed(2)}‚Ç¨</span>
                        </div>
                        <hr style="margin: 8px 0; border: none; border-top: 1px solid #ddd;">
                        <div class="breakdown-item" style="font-weight: 700; font-size: 1.1em;">
                            <span class="breakdown-label">Co√ªt TOTAL:</span>
                            <span class="breakdown-value" style="color: var(--danger);">${mat.totalCost.toFixed(2)}‚Ç¨</span>
                        </div>
                    </div>
                    
                    <span class="category-badge">${mat.category}</span>
                </div>
            `,
          )
          .join("");
      }

      function filterBySearch(materials, type) {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();

        return materials.filter((mat) => {
          const matchesSearch =
            mat.name.toLowerCase().includes(searchTerm) ||
            mat.category.toLowerCase().includes(searchTerm);
          const matchesFilter =
            currentFilter === "all" || currentFilter === type;
          return matchesSearch && matchesFilter;
        });
      }

      function setupSearch() {
        document.getElementById("searchInput").addEventListener("input", () => {
          renderMaterials();
        });
      }

      function filterMaterials(type) {
        currentFilter = type;
        renderMaterials();
      }

      function updateStats() {
        const all = [...allMaterials.simple, ...allMaterials.composite];
        const prices = all.map((m) => m.totalCost || m.pricePerUnit);

        document.getElementById("stat-simple").textContent =
          allMaterials.simple.length;
        document.getElementById("stat-composite").textContent =
          allMaterials.composite.length;
        document.getElementById("stat-min").textContent =
          Math.min(...prices).toFixed(2) + "‚Ç¨";
        document.getElementById("stat-max").textContent =
          Math.max(...prices).toFixed(2) + "‚Ç¨";
      }
    </script>
  </body>
</html>
